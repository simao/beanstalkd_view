<div class="row span12">
  <h1>Overview</h1>
</div>

<div class="row">
<div class="span6">

  <table class="table">
    <thead>
      <tr>
        <th>Server</th>
        <th>Tubes</th>
      </tr>
    </thead>
    <tbody>
      <% @tubes.keys.each do |key| %>
        <% @tubes[key].sort.each do |tube| %>
          <tr>
            <td><%= key %></td>
            <td><a href="<%= u("/tube/#{tube}") %>"><%= tube %></a></td>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>

	<table class="table">
        <thead>
          <tr>
            <th colspan="2">Current Jobs</th>
          </tr>
        </thead>
        <tbody>
          <tr rel="tooltip" title="The number of ready jobs with priority < 1024.">
            <td>Urgent</td>
			<% if @stats["current-jobs-urgent"] > 0 %>
              <td class="data_cell"><span class="badge badge-warning"><%= @stats["current-jobs-urgent"] %></span></td>
			<% else %>
              <td class="data_cell"><%= @stats["current-jobs-urgent"] %></td>
			<% end %>
          </tr>
          <tr rel="tooltip" title="The number of jobs in the ready queue.">
            <td>Ready</td>
            <td class="data_cell"><%= @stats["current-jobs-ready"] %></td>
          </tr>
          <tr rel="tooltip" title="The number of jobs reserved by all clients.">
            <td>Reserved</td>
            <td class="data_cell"><%= @stats["current-jobs-reserved"] %></td>
          </tr>
          <tr rel="tooltip" title="The number of delayed jobs.">
            <td>Delayed</td>
            <td class="data_cell"><%= @stats["current-jobs-delayed"] %></td>
          </tr>
          <tr rel="tooltip" title="he number of buried jobs.">
            <td>Buried</td>
			<% if @stats["current-jobs-buried"] > 0 %>
              <td class="data_cell"><span class="badge badge-error"><%= @stats["current-jobs-buried"] %></span></td>
			<% else %>
              <td class="data_cell"><%= @stats["current-jobs-buried"] %></td>
            <% end %>
          </tr>
        </tbody>
      </table>

      <table class="table">
	     <thead>
	        <tr>
	          <th colspan="2">Meta Statistics</th>
	        </tr>
	      </thead>
	      <tbody>
	        <tr rel="tooltip" title="The rate of job bury calls to reserve calls.">
	          <td>Bury Rate</td>
			  <% bury_reserve_rate = (@stats["cmd-bury"].to_f / @stats["cmd-reserve"].to_f) %>
			  <% bury_reserve_rate = 0 if bury_reserve_rate.nan? %>
			  <% if bury_reserve_rate > 0.01 %>
	          	<td class="data_cell"><span class="badge badge-error"><%= bury_reserve_rate %></span></td>
	          <% else %>
	            <td class="data_cell"><%= bury_reserve_rate %></td>
	          <% end %>
	        </tr>
			<tr rel="tooltip" title="The rate of job timeouts to reserve calls.">
	          <td>Timeout Rate</td>
	          <% timeout_reserve_rate = (@stats["job-timeouts"].to_f / @stats["cmd-reserve"].to_f) %>
	          <% timeout_reserve_rate = 0 if timeout_reserve_rate.nan? %>
			  <% if timeout_reserve_rate > 0.01 %>
	          	<td class="data_cell"><span class="badge badge-error"><%= timeout_reserve_rate %></span></td>
	          <% else %>
	            <td class="data_cell"><%= timeout_reserve_rate %></td>
	          <% end %>
	        </tr>
	 	</tbody>
	  </table>

      <table class="table">
        <thead>
          <tr>
            <th colspan="2">Statistics</th>
          </tr>
        </thead>
        <tbody>
          <tr rel="tooltip" title="The cumulative count of times a job has timed out.">
            <td>Job Timeouts</td>
            <td class="data_cell"><%= @stats["job-timeouts"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative count of jobs created.">
            <td>Total Jobs</td>
            <td class="data_cell"><%= @stats["total-jobs"] %></td>
          </tr>
          <tr rel="tooltip" title="The maximum number of bytes in a job.">
            <td>Max Job Size</td>
            <td class="data_cell"><%= @stats["max-job-size"] %></td>
          </tr>
          <tr rel="tooltip" title="The number of currently open connections.">
            <td>Current Connections</td>
            <td class="data_cell"><%= @stats["current-connections"] %></td>
          </tr>
          <tr rel="tooltip" title="The number of open connections that have each issued at least one put command.">
            <td>Current Producers</td>
            <td class="data_cell"><%= @stats["current-producers"] %></td>
          </tr>
          <tr rel="tooltip" title="The number of open connections that have each issued at least one reserve command.">
            <td>Current Workers</td>
            <td class="data_cell"><%= @stats["current-workers"] %></td>
          </tr>
          <tr rel="tooltip" title="The number of open connections that have issued a reserve command but not yet received a response.">
            <td>Current Waiting</td>
            <td class="data_cell"><%= @stats["current-waiting"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative count of connections.">
            <td>Total Connections</td>
            <td class="data_cell"><%= @stats["total-connections"] %></td>
          </tr>
          <tr rel="tooltip" title="The process id of the server.">
            <td>pid</td>
            <td class="data_cell"><%= @stats["pid"] %></td>
          </tr>
          <tr rel="tooltip" title="The version string of the server.">
            <td>Version</td>
            <td class="data_cell"><%= @stats["version"] %></td>
          </tr>
          <tr rel="tooltip" title="The accumulated user CPU time of this process in seconds and microseconds.">
            <td>rusage-utime</td>
            <td class="data_cell"><%= @stats["rusage-utime"] %></td>
          </tr>
          <tr rel="tooltip" title="The accumulated system CPU time of this process in seconds and microseconds.">
            <td>rusage-stime</td>
            <td class="data_cell"><%= @stats["rusage-stime"] %></td>
          </tr>
          <tr rel="tooltip" title="The number of seconds since this server started running.">
            <td>Uptime</td>
            <td class="data_cell"><%= @stats["uptime"] %></td>
          </tr>
        </tbody>
      </table>

	  <table class="table">
        <thead>
          <tr>
            <th colspan="2">Binlog</th>
          </tr>
        </thead>
        <tbody>
          <tr rel="tooltip" title="The index of the oldest binlog file needed to store the current jobs.">
            <td>Oldest Index</td>
            <td class="data_cell"><%= @stats["binlog-oldest-index"] %></td>
          </tr>
          <tr rel="tooltip" title="The index of the current binlog file being written to. If binlog is not active this value will be 0.">
            <td>Current Index</td>
            <td class="data_cell"><%= @stats["binlog-current-index"] %></td>
          </tr>
          <tr rel="tooltip" title="The maximum size in bytes a binlog file is allowed to get before a new binlog file is opened.">
            <td>Max Size</td>
            <td class="data_cell"><%= @stats["binlog-max-size"] %></td>
          </tr>
        </tbody>
      </table>

      <hr/>

      <table class="table">
        <thead>
          <tr>
            <th colspan="2">API Call Histogram</th>
          </tr>
        </thead>
        <tbody>
          <tr rel="tooltip" title="The cumulative number of put commands.">
            <td>put</td>
            <td class="data_cell"><%= @stats["cmd-put"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of peek commands.">
            <td>peek</td>
            <td class="data_cell"><%= @stats["cmd-peek"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of peek-ready commands.">
            <td>peek-ready</td>
            <td class="data_cell"><%= @stats["cmd-peek-ready"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of peek-delayed commands.">
            <td>peek-delayed</td>
            <td class="data_cell"><%= @stats["cmd-peek-delayed"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of peek-buried commands.">
            <td>peek-buried</td>
            <td class="data_cell"><%= @stats["cmd-peek-buried"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of reserve commands.">
            <td>reserve</td>
            <td class="data_cell"><%= @stats["cmd-reserve"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of use commands.">
            <td>use</td>
            <td class="data_cell"><%= @stats["cmd-use"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of watch commands.">
            <td>watch</td>
            <td class="data_cell"><%= @stats["cmd-watch"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of ignore commands.">
            <td>ignore</td>
            <td class="data_cell"><%= @stats["cmd-ignore"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of delete commands.">
            <td>delete</td>
            <td class="data_cell"><%= @stats["cmd-delete"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of release commands.">
            <td>release</td>
            <td class="data_cell"><%= @stats["cmd-release"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of bury commands.">
            <td>bury</td>
            <td class="data_cell"><%= @stats["cmd-bury"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of kick commands.">
            <td>kick</td>
            <td class="data_cell"><%= @stats["cmd-kick"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of stats commands.">
            <td>stats</td>
            <td class="data_cell"><%= @stats["cmd-stats"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of stats-job commands.">
            <td>stats-job</td>
            <td class="data_cell"><%= @stats["cmd-stats-job"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of stats-tube commands.">
            <td>stats-tube</td>
            <td class="data_cell"><%= @stats["cmd-stats-tube"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of list-tubes commands.">
            <td>list-tubes</td>
            <td class="data_cell"><%= @stats["cmd-list-tubes"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of list-tube-used commands.">
            <td>list-tube-used</td>
            <td class="data_cell"><%= @stats["cmd-list-tube-used"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of list-tubes-watched commands.">
            <td>list-tubes-watched</td>
            <td class="data_cell"><%= @stats["cmd-list-tubes-watched"] %></td>
          </tr>
          <tr rel="tooltip" title="The cumulative number of pause-tube commands.">
            <td>pause-tube</td>
            <td class="data_cell"><%= @stats["cmd-pause-tube"] %></td>
          </tr>
        </tbody>
      </table>
	</div>
	
	<div class="span6">
	  <div id="total_jobs_container">
	    <h3>Total Jobs</h3>
	    <canvas id="total_jobs_chart"></canvas>
	  </div>
	  <div id="buried_jobs_container" style="visibility:hidden">
	    <br/>
	    <h3>Current Jobs Buried</h3>
	    <canvas id="buried_jobs_chart"></canvas>
	  </div>
	</div>
</div>

<script type="text/javascript">
$(document).ready(function(){
	
	function draw_chart(div, data) {
		//Create pie charts
		var chart = new Bluff.Bar(div, 460);
	    //Setup theme
	    var colors = ['#6886B4', '#FDD84E', '#72AE6E', '#D1695E', '#8A6EAF', '#EFAA43', 'white'];  
	  	chart.set_theme({
                  colors: colors,
        	  marker_color: 'white',
        	  font_color: 'white',
//        	  background_colors: ['#008000', '#008000']
        	});
		chart.tooltips = true;
		chart.hide_line_markers = false;
		chart.minimum_value = 0;
		var max_value = 0;
		//Add each data item to chart
		for (i in data.items) {
		  var item = data.items[i];
		  chart.data(item.label, item.data);
		  if (item.data > max_value) {
			max_value = item.data;
		  }
		}
		chart.maximum_value = max_value;
		//Finally draw the chart
		chart.draw();
	}


	<% if @total_jobs_data %>
		var total_jobs_data = <%= @total_jobs_data.to_json %>
		draw_chart('total_jobs_chart', total_jobs_data);
	<% end %>

	<% if @buried_jobs_data %>
	  var buried_jobs_data = <%= @buried_jobs_data.to_json %>	
	  draw_chart('buried_jobs_chart', buried_jobs_data);
	  $("#buried_jobs_container").css('visibility', 'visible');
	<% end %>
	
	//Setup Typeahead For Tube Names on Add Job Form
	var tubeNames = [];
	<% @tube_set.each do |tube| %>
	  tubeNames.push('<%=tube%>');
	<% end %>
	$('#form_tube_name').typeahead({source: tubeNames});
});
</script>

<%= erb :job_info_popup %>
